<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <title>Beyond Reality Face SDK - BRFv5 - Face Tracking for Browser/JavaScript - Minimal Webcam Example</title>
    <script src="Build/UnityLoader.js"></script>
    <link rel="stylesheet" href="style.css">

    <style>
        html,
        body {
            width: 100%;
            height: 100%;
            background-color: #ffffff;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        .abs {
            position: absolute
        }

        .vh {
            visibility: hidden
        }
    </style>
</head>

<body>
    <canvas id="myCanvas">
        Your browser does not support the canvas element.
    </canvas>
    <div id='container'>
        <video id="_webcam" style="display: none;" playsinline></video>
        <canvas id="_imageData"></canvas>
    </div>
    <div id="unityContainer"> </div>

    <br><br>
    <div id="btn">
        <button onclick="load()">
            load
        </button>
        <button onclick="pass()">
            pass
        </button>
        <br>
        <input id="xxx" type="text" placeholder="Stiffness Force">
        <br>
        <input id="yyy" type="text" placeholder="Drag Force">
        <br>
        <br>
        <button onclick="poss()">Dangling</button>
        <br>
        <div>
            <input id="lx" type="number" placeholder="left-x">
            <input id="ly" type="number" placeholder="left-y">
            <input id="rx" type="number" placeholder="right-x">
            <input id="ry" type="number" placeholder="right-y">
        </div>
        <br>
        <br>
        <div>
            <input id="xr" type="number" placeholder="x">
            <input id="yr" type="number" placeholder="y">
            <input id="zr" type="number" placeholder="x">
        </div>
        <button onclick="rotate()">
            Rotate
        </button>
        <script>
            function pass() {
                console.log("clicked");
                var s = JSON.parse('{"positionForRight":{"x": 0,"y": 0,"z": 0},"positionForLeft":{"x": 0,"y": 0,"z": 0},"scaleForLeft":{"x": 3.5,"y": 3.5,"z": 3.5},"scaleForRight":{"x": 3.5,"y": 3.5,"z": 3.5}}');
                console.log(s);
                unity.SendMessage('ObjectContainer', 'TrsnsformObject', JSON.stringify(s));
            }

            function load() {
                unity.SendMessage('Earring', 'LoadContent', "https://mirrar.s3.ap-south-1.amazonaws.com/amazingabhishek/AssetBundles/dummyear");
            }

            function poss() {
                let p = {
                    x: document.getElementById("xxx").value,
                    y: document.getElementById("yyy").value
                }

                unity.SendMessage('ObjectContainer', 'SetMovement', JSON.stringify(p));
            }

            function rotate() {
                var r = {
                    x: document.getElementById("xr").value,
                    y: document.getElementById("yr").value,
                    z: document.getElementById("z").value
                }
                console.log('rotation ' + r);
                unity.SendMessage('facemask', 'RotateMask', JSON.stringify(r));
            }
        </script>
    </div>

    <script>
        var unity = UnityLoader.instantiate("unityContainer", "Build/WebGL.json");
    </script>

    <script type="module">

        import { brfv5 } from './js/brfv5/brfv5__init.js'
        import { loadBRFv5Model } from './js/brfv5/brfv5__init.js'
        import { configureCameraInput } from './js/brfv5/brfv5__configure.js'
        import { configureFaceTracking } from './js/brfv5/brfv5__configure.js'
        import { configureNumFacesToTrack } from './js/brfv5/brfv5__configure.js'
        import { startCamera } from './js/utils/utils__camera.js'
        import { drawInputMirrored } from './js/utils/utils__canvas.js'

        import {
            mountPNGOverlay, setSizePNGOverlay, hidePNGOverlay,
            loadPNGOverlays, updateByFace
        } from './js/ui/ui__overlay__png.js'
        import { ScaleMode } from './js/utils/utils__resize.js'

        function angle(originX, originY, targetX, targetY) {
            var dx = originX - targetX;
            var dy = originY - targetY;

            // var theta = Math.atan2(dy, dx);  // [0, Ⲡ] then [-Ⲡ, 0]; clockwise; 0° = west
            // theta *= 180 / Math.PI;          // [0, 180] then [-180, 0]; clockwise; 0° = west
            // if (theta < 0) theta += 360;     // [0, 360]; clockwise; 0° = west

            // var theta = Math.atan2(-dy, dx); // [0, Ⲡ] then [-Ⲡ, 0]; anticlockwise; 0° = west
            // theta *= 180 / Math.PI;          // [0, 180] then [-180, 0]; anticlockwise; 0° = west
            // if (theta < 0) theta += 360;     // [0, 360]; anticlockwise; 0° = west

            // var theta = Math.atan2(dy, -dx); // [0, Ⲡ] then [-Ⲡ, 0]; anticlockwise; 0° = east
            // theta *= 180 / Math.PI;          // [0, 180] then [-180, 0]; anticlockwise; 0° = east
            // if (theta < 0) theta += 360;     // [0, 360]; anticlockwise; 0° = east

            var theta = Math.atan2(-dy, -dx); // [0, Ⲡ] then [-Ⲡ, 0]; clockwise; 0° = east
            theta *= 180 / Math.PI;           // [0, 180] then [-180, 0]; clockwise; 0° = east
            if (theta < 0) theta += 360;      // [0, 360]; clockwise; 0° = east

            return theta;
        }

        const _images = [
            {
                // url: './assets/brfv5_img_lion.png', alpha: 0.66,
                // scale: 0.66, xOffset: 0.5, yOffset: 0.40
            },
            {
                // url: './assets/brfv5_img_glasses.png', alpha: 1.00,
                // scale: 0.25, xOffset: 0.5, yOffset: 0.45
            }
        ];

        mountPNGOverlay(document.getElementById('container'), ScaleMode.NO_SCALE)
        loadPNGOverlays(_images)

        const _appId = 'brfv5.browser.minimal.modules.pngoverlay' // (mandatory): 8 to 64 characters, a-z . 0-9 allowed

        const _webcam = document.getElementById('_webcam')
        const _imageData = document.getElementById('_imageData')

        let _brfv5Manager = null
        let _brfv5Config = null
        let _width = 0
        let _height = 0

        startCamera(_webcam, { width: 640, height: 480, frameRate: 30, facingMode: 'user' }).then(({ video }) => {

            console.log('openCamera: done: ' + video.videoWidth + 'x' + video.videoHeight)

            _width = video.videoWidth
            _height = video.videoHeight

            _imageData.width = _width
            _imageData.height = _height

            const container = document.getElementById("container")
            container.style.width = _width + 'px'
            container.style.height = _height + 'px'

            setSizePNGOverlay(_width, _height)

            configureTracking()

        }).catch((e) => { if (e) { console.error('Camera failed: ', e) } })

        loadBRFv5Model('68l', 8, './js/brfv5/models/', _appId,
            (progress) => { console.log(progress) }).then(({ brfv5Manager, brfv5Config }) => {

                console.log('loadBRFv5Model: done')

                _brfv5Manager = brfv5Manager
                _brfv5Config = brfv5Config

                configureTracking()

            }).catch((e) => { console.error('BRFv5 failed: ', e) })

        const configureTracking = () => {

            if (_brfv5Config !== null && _width > 0) {

                configureCameraInput(_brfv5Config, _width, _height)
                configureNumFacesToTrack(_brfv5Config, 1)
                configureFaceTracking(_brfv5Config, 3, true)

                _brfv5Manager.configure(_brfv5Config)

                trackFaces()
            }
        }

        const trackFaces = () => {

            if (!_brfv5Manager || !_brfv5Config || !_imageData) { return }

            const ctx = _imageData.getContext('2d')

            drawInputMirrored(ctx, _width, _height, _webcam)

            hidePNGOverlay()

            _brfv5Manager.update(ctx.getImageData(0, 0, _width, _height))

            const faces = _brfv5Manager.getFaces();
            unity.SendMessage('ObjectContainer', 'setScale', 0.1);
            var canvas = document.getElementById("myCanvas");
            var unityContainer = document.getElementById("unityContainer");
            canvas.setAttribute('width', '640px');
            canvas.setAttribute('height', '480px');
            unityContainer.style.width = "640px"
            unityContainer.style.height = "480px"
            var context = canvas.getContext("2d");
            context.font = "7px Arial";

            var left_x = document.getElementById("lx").value;
            var left_y = document.getElementById("ly").value;
            var right_x = document.getElementById("rx").value;
            var right_y = document.getElementById("ry").value;

            let distanceBetween = (point1, point2) => {
                return Math.sqrt(Math.pow((point1.x - point2.x), 2)
                    + Math.pow((point1.y - point2.y), 2));
            }

            for (let i = 0; i < faces.length; i++) {

                // console.log(`${left_x} :: ${left_y} :: ${right_x} :: ${right_y}`)
                let left = {
                    x: parseFloat(((faces[i].landmarks[1].x + + left_x) - 320) / 42),
                    y: parseFloat(((240 - (faces[i].landmarks[1].y) + + left_y) / 42) + 1),
                    z: 0
                };

                let right = {
                    x: parseFloat(((faces[i].landmarks[15].x + +right_x) - 320) / 42),
                    y: parseFloat(((240 - (faces[i].landmarks[15].y + + right_y)) / 42) + 1),
                    z: 0
                };

                let finalObject = {
                    positionForRight: right,
                    positionForLeft: left,
                    scaleForLeft: {
                        x: 2, y: 2, z: 2
                    },
                    scaleForRight: {
                        x: 2, y: 2, z: 2
                    }
                }

                let pos = {
                    vectors: []
                };
                context.clearRect(0, 0, canvas.width, canvas.height);

                for (let j = 0; j < faces[i].landmarks.length; j++) {
                    context.fillText(j, faces[i].landmarks[j].x, faces[i].landmarks[j].y);
                    pos.vectors.push({
                        x: parseFloat(((faces[i].landmarks[j].x) - 320) / 42),
                        y: parseFloat(((240 - (faces[i].landmarks[j].y)) / 42) + 1),
                        z: 0
                    })
                }

                let faceWidth = distanceBetween(faces[i].landmarks[0], faces[i].landmarks[16])
                let faceHeight = distanceBetween(faces[i].landmarks[27], faces[i].landmarks[8]);
                let forhead = distanceBetween(faces[i].landmarks[27], faces[i].landmarks[30]);

                let fullFaceHeight = faceHeight + forhead;

                let faceCenter = {
                    x: (((faces[i].landmarks[0].x + faces[i].landmarks[16].x) / 2) - 320) / 42,
                    y: ((240 - faces[i].landmarks[30].y) / 42) + 1.5
                }

                let mask = {
                    scale: { x: faceWidth / 6, y: fullFaceHeight / 7 },
                    position: { x: faceCenter.x, y: faceCenter.y, z: -5 }
                }

                console.log(JSON.stringify(pos));

                unity.SendMessage('Earring', 'FaceMask', JSON.stringify(mask))
                // unity.SendMessage('ObjectContainer', 'printMask', JSON.stringify(pos))

                const face = faces[i]
                if (face.state === brfv5.BRFv5State.FACE_TRACKING) {
                    updateByFace(face, i, true)
                } else {
                    updateByFace(null, i, false)
                }
            }
            requestAnimationFrame(trackFaces)
        }
    </script>

</body>

</html>